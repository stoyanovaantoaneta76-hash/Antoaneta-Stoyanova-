name: Publish nordlys-core

on:
  push:
    tags:
      - "core-v*"

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================
  # Build Wheels (CPU and CUDA in parallel)
  # ============================================
  build_wheels_cpu:
    uses: ./.github/workflows/_build-wheels-cpu.yml
    with:
      validate-version: true

  build_wheels_cuda:
    uses: ./.github/workflows/_build-wheels-cuda.yml
    with:
      validate-version: true

  # ============================================
  # Publish all wheels
  # ============================================
  publish:
    needs: [build_wheels_cpu, build_wheels_cuda]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: cibw-wheels-*
          path: dist
          merge-multiple: true

      - name: List wheels
        run: ls -la dist/

      - name: Validate wheel versions
        shell: bash
        run: |
          VERSION=$(cat nordlys-core/VERSION | tr -d '[:space:]')
          cd dist
          for file in *.whl; do
            if [[ "$file" != *"$VERSION"* ]]; then
              echo "Error: Found wheel without $VERSION: $file"
              exit 1
            fi
          done
          echo "All wheels validated for version $VERSION"

      - uses: pypa/gh-action-pypi-publish@release/v1

